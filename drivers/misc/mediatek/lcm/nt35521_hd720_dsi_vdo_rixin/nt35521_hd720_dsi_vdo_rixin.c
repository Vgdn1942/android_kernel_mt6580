/*----------------------------------------------------------------
 * Author : Yuvraj Saxena (frap13000@github.com)
 * Contact : frap13000@gmail.com
 * Note : (Don't remove this block of code from here!)
 * Neither you and nor your any friends or family members will!
 * change credits from here! you know the consequences of removing!
 *---------------------------------------------------------------*/

#ifndef BUILD_LK
#include <linux/string.h>
#endif
#include "lcm_drv.h"

#ifdef BUILD_LK
	#include <platform/mt_gpio.h>
#elif defined(BUILD_UBOOT)
	#include <asm/arch/mt_gpio.h>
#else
	#include <mach/mt_gpio.h>
#endif

/* ---------------------------------------------------------------------------
   Local Constants
   --------------------------------------------------------------------------- */

#define FRAME_WIDTH  (720)
#define FRAME_HEIGHT (1280)

#ifndef TRUE
    #define TRUE 1
#endif

#ifndef FALSE
    #define FALSE 0
#endif

#define REGFLAG_DELAY                                       0XFC
#define REGFLAG_END_OF_TABLE                                0xFD


#define LCM_ID_NT35590 (0x90)

/* ---------------------------------------------------------------------------
   Local Variables
   --------------------------------------------------------------------------- */

static LCM_UTIL_FUNCS lcm_util = {0};

#define SET_RESET_PIN(v)    (lcm_util.set_reset_pin((v)))

#define UDELAY(n) (lcm_util.udelay(n))
#define MDELAY(n) (lcm_util.mdelay(n))

/* ---------------------------------------------------------------------------
   Local Functions
   --------------------------------------------------------------------------- */

#define dsi_set_cmdq_V2(cmd, count, ppara, force_update)	        lcm_util.dsi_set_cmdq_V2(cmd, count, ppara, force_update)
#define dsi_set_cmdq(pdata, queue_size, force_update)		lcm_util.dsi_set_cmdq(pdata, queue_size, force_update)
#define wrtie_cmd(cmd)										lcm_util.dsi_write_cmd(cmd)
#define write_regs(addr, pdata, byte_nums)					lcm_util.dsi_write_regs(addr, pdata, byte_nums)
#define read_reg(cmd)											lcm_util.dsi_dcs_read_lcm_reg(cmd)
#define read_reg_v2(cmd, buffer, buffer_size)   				lcm_util.dsi_dcs_read_lcm_reg_v2(cmd, buffer, buffer_size)   

static struct LCM_setting_table
{
    unsigned cmd;
    unsigned char count;
    unsigned char para_list[64];
};

static struct LCM_setting_table lcm_initialization_setting[] =
{
{0xf0, 5, {0x55,0xaa,0x52,0x08,0x00}},
{0xc8, 1, {0x00}},
{0xf0, 5, {0x55,0xaa,0x52,0x08,0x01}},
{0xbc, 2, {0x90,0x00}},
{0xbd, 2, {0x90,0x00}},
{0xca, 1, {0x01}},
{0xc0, 1, {0x0c}},
{0xbe, 1, {0x60}},
{0xb3, 2, {0x38,0x38}},
{0xb4, 2, {0x11,0x11}},
{0xb6, 2, {0x05,0x05}},
{0xb9, 2, {0x45,0x45}},
{0xba, 2, {0x25,0x25}},
{0xc4, 2, {0x11,0x11}},
{0xce, 1, {0x66}},
{0xf0, 5, {0x55,0xaa,0x52,0x08,0x02}},
{0xb0, 16, {0x00,0x17,0x00,0x53,0x00,0x82,0x00,0x9f,0x00,0xb4,0x00,0xd8,0x00,0xf3,0x01,0x1d}},
{0xb1, 16, {0x01,0x40,0x01,0x78,0x01,0xa1,0x01,0xe5,0x02,0x1c,0x02,0x1d,0x02,0x4f,0x02,0x86}},
{0xb2, 16, {0x02,0xaa,0x02,0xda,0x02,0xf9,0x03,0x26,0x03,0x3e,0x03,0x5e,0x03,0x6d,0x03,0x6e}},
{0xb3, 4, {0x03,0xd5,0x03,0xe7}},
{0xb4, 16, {0x00,0x1d,0x00,0x4f,0x00,0x7e,0x00,0x99,0x00,0xb1,0x00,0xd4,0x00,0xf1,0x01,0x1c}},
{0xb5, 16, {0x01,0x3f,0x01,0x75,0x01,0xa0,0x01,0xe3,0x02,0x1a,0x02,0x1c,0x02,0x4f,0x02,0x86}},
{0xb6, 16, {0x02,0xaa,0x02,0xdb,0x02,0xfd,0x03,0x28,0x03,0x45,0x03,0x6a,0x03,0x7b,0x03,0xc2}},
{0xb7, 4, {0x03,0xd3,0x03,0xed}},
{0xb8, 16, {0x00,0x04,0x00,0x41,0x00,0x6d,0x00,0x8a,0x00,0xa1,0x00,0xc7,0x00,0xe5,0x01,0x12}},
{0xb9, 16, {0x01,0x36,0x01,0x6e,0x01,0x9a,0x01,0xe0,0x02,0x18,0x02,0x19,0x02,0x4d,0x02,0x85}},
{0xba, 16, {0x02,0xa9,0x02,0xdc,0x02,0xff,0x03,0x2f,0x03,0x52,0x03,0x95,0x03,0xd5,0x03,0xf1}},
{0xbb, 4, {0x03,0xf8,0x03,0xfb}},
{0xbc, 16, {0x00,0x17,0x00,0x53,0x00,0x82,0x00,0x9f,0x00,0xb4,0x00,0xd8,0x00,0xf3,0x01,0x1d}},
{0xbd, 16, {0x01,0x40,0x01,0x78,0x01,0xa1,0x01,0xe5,0x02,0x1c,0x02,0x1d,0x02,0x4f,0x02,0x86}},
{0xbe, 16, {0x02,0xaa,0x02,0xda,0x02,0xf9,0x03,0x26,0x03,0x3e,0x03,0x5e,0x03,0x6d,0x03,0x6e}},
{0xbf, 4, {0x03,0xd5,0x03,0xe7}},
{0xc0, 16, {0x00,0x1d,0x00,0x4f,0x00,0x7e,0x00,0x99,0x00,0xb1,0x00,0xd4,0x00,0xf1,0x01,0x1c}},
{0xc1, 16, {0x01,0x3f,0x01,0x75,0x01,0xa0,0x01,0xe3,0x02,0x1a,0x02,0x1c,0x02,0x4f,0x02,0x86}},
{0xc2, 16, {0x02,0xaa,0x02,0xdb,0x02,0xfd,0x03,0x28,0x03,0x45,0x03,0x6a,0x03,0x7b,0x03,0xc2}},
{0xc3, 4, {0x03,0xd3,0x03,0xed}},
{0xc4, 16, {0x00,0x04,0x00,0x41,0x00,0x6d,0x00,0x8a,0x00,0xa1,0x00,0xc7,0x00,0xe5,0x01,0x12}},
{0xc5, 16, {0x01,0x36,0x01,0x6e,0x01,0x9a,0x01,0xe0,0x02,0x18,0x02,0x19,0x02,0x4d,0x02,0x85}},
{0xc6, 16, {0x02,0xa9,0x02,0xdc,0x02,0xff,0x03,0x2f,0x03,0x52,0x03,0x95,0x03,0xd5,0x03,0xf1}},
{0xc7, 4, {0x03,0xf8,0x03,0xfb}},
{0xf0, 5, {0x55,0xaa,0x52,0x08,0x06}},
{0xb0, 2, {0x29,0x2a}},
{0xb1, 2, {0x10,0x12}},
{0xb2, 2, {0x14,0x16}},
{0xb3, 2, {0x18,0x1a}},
{0xb4, 2, {0x02,0x04}},
{0xb5, 2, {0x34,0x34}},
{0xb6, 2, {0x34,0x2e}},
{0xb7, 2, {0x2e,0x2e}},
{0xb8, 2, {0x34,0x00}},
{0xb9, 2, {0x34,0x34}},
{0xba, 2, {0x34,0x34}},
{0xbb, 2, {0x01,0x34}},
{0xbc, 2, {0x2e,0x2e}},
{0xbd, 2, {0x2e,0x34}},
{0xbe, 2, {0x34,0x34}},
{0xbf, 2, {0x05,0x03}},
{0xc0, 2, {0x1b,0x19}},
{0xc1, 2, {0x17,0x15}},
{0xc2, 2, {0x13,0x11}},
{0xc3, 2, {0x2a,0x29}},
{0xe5, 2, {0x2e,0x2e}},
{0xc4, 2, {0x29,0x2a}},
{0xc5, 2, {0x1b,0x19}},
{0xc6, 2, {0x17,0x15}},
{0xc7, 2, {0x13,0x11}},
{0xc8, 2, {0x01,0x05}},
{0xc9, 2, {0x34,0x34}},
{0xca, 2, {0x34,0x2e}},
{0xcb, 2, {0x2e,0x2e}},
{0xcc, 2, {0x34,0x03}},
{0xcd, 2, {0x34,0x34}},
{0xce, 2, {0x34,0x34}},
{0xcf, 2, {0x02,0x34}},
{0xd0, 2, {0x2e,0x2e}},
{0xd1, 2, {0x2e,0x34}},
{0xd2, 2, {0x34,0x34}},
{0xd3, 2, {0x04,0x00}},
{0xd4, 2, {0x10,0x12}},
{0xd5, 2, {0x14,0x16}},
{0xd6, 2, {0x18,0x1a}},
{0xd7, 2, {0x2a,0x29}},
{0xe6, 2, {0x2e,0x2e}},
{0xd8, 5, {0x00,0x00,0x00,0x54,0x00}},
{0xd9, 5, {0x00,0x15,0x00,0x00,0x00}},
{0xe7, 1, {0x00}},
{0xf0, 5, {0x55,0xaa,0x52,0x08,0x03}},
{0xb1, 2, {0x00,0x00}},
{0xb0, 2, {0x00,0x00}},
{0xb2, 5, {0x05,0x00,0x00,0x00,0x00}},
{0xb3, 5, {0x05,0x00,0x00,0x00,0x00}},
{0xb4, 5, {0x05,0x00,0x00,0x00,0x00}},
{0xb5, 5, {0x05,0x00,0x17,0x00,0x00}},
{0xb6, 5, {0x12,0x00,0x19,0x00,0x00}},
{0xb7, 5, {0x12,0x00,0x19,0x00,0x00}},
{0xb8, 5, {0x12,0x00,0x19,0x00,0x00}},
{0xb9, 5, {0x12,0x00,0x19,0x00,0x00}},
{0xba, 5, {0x57,0x00,0x00,0x00,0x00}},
{0xbb, 5, {0x57,0x00,0x00,0x00,0x00}},
{0xbc, 5, {0x75,0x00,0x1a,0x00,0x00}},
{0xbd, 5, {0x53,0x00,0x1a,0x00,0x00}},
{0xc0, 4, {0x00,0x34,0x00,0x00}},
{0xc1, 4, {0x00,0x34,0x00,0x00}},
{0xc2, 4, {0x00,0x34,0x00,0x00}},
{0xc3, 4, {0x00,0x34,0x00,0x00}},
{0xc4, 1, {0x20}},
{0xc5, 1, {0x00}},
{0xc6, 1, {0x00}},
{0xc7, 1, {0x00}},
{0xf0, 5, {0x55,0xaa,0x52,0x08,0x05}},
{0xed, 1, {0x30}},
{0xb0, 2, {0x17,0x06}},
{0xb8, 1, {0x08}},
{0xbd, 5, {0x03,0x07,0x00,0x03,0x00}},
{0xb1, 2, {0x17,0x06}},
{0xb9, 1, {0x00}},
{0xb2, 2, {0x00,0x00}},
{0xba, 1, {0x00}},
{0xb3, 2, {0x17,0x06}},
{0xbb, 1, {0x0a}},
{0xb4, 2, {0x17,0x06}},
{0xb5, 2, {0x17,0x06}},
{0xb6, 2, {0x14,0x03}},
{0xb7, 2, {0x00,0x00}},
{0xbc, 1, {0x02}},
{0xe5, 1, {0x06}},
{0xe6, 1, {0x06}},
{0xe7, 1, {0x00}},
{0xe8, 1, {0x06}},
{0xe9, 1, {0x06}},
{0xea, 1, {0x06}},
{0xeb, 1, {0x00}},
{0xec, 1, {0x00}},
{0xc0, 1, {0x07}},
{0xc1, 1, {0x80}},
{0xc2, 1, {0xa4}},
{0xc3, 1, {0x05}},
{0xc4, 1, {0x00}},
{0xc5, 1, {0x02}},
{0xc6, 1, {0x22}},
{0xc7, 1, {0x03}},
{0xc8, 2, {0x05,0x30}},
{0xc9, 2, {0x01,0x31}},
{0xca, 2, {0x03,0x21}},
{0xcb, 2, {0x01,0x20}},
{0xd1, 5, {0x00,0x05,0x09,0x07,0x10}},
{0xd2, 5, {0x10,0x05,0x0e,0x03,0x10}},
{0xd3, 5, {0x20,0x00,0x48,0x07,0x10}},
{0xd4, 5, {0x30,0x00,0x43,0x07,0x10}},
{0xd0, 1, {0x00}},
{0xcc, 3, {0x00,0x00,0x3e}},
{0xcd, 3, {0x00,0x00,0x3e}},
{0xce, 3, {0x00,0x00,0x02}},
{0xcf, 3, {0x00,0x00,0x02}},
{0x6f, 1, {0x11}},
{0xf3, 1, {0x01}},
{0x35, 1, {0x00}},
{0x62, 1, {0x01}},
{0xff, 4, {0xaa,0x55,0x25,0x01}},
{0x6f, 2, {0x16,0x00}},
{0xf7, 2, {0x10,0x00}},
{0x11, 1, {0x00}},
{REGFLAG_DELAY, 120, {}},
{0x29, 1, {0x00}},
{REGFLAG_DELAY, 50, {}},
{REGFLAG_END_OF_TABLE, 0x00, {}},
};

static void push_table(struct LCM_setting_table *table, unsigned int count, unsigned char force_update)
{
    unsigned int i;

    for(i = 0; i < count; i++)
    {

        unsigned cmd;
        cmd = table[i].cmd;

        switch (cmd)
        {

            case REGFLAG_DELAY :
                MDELAY(table[i].count);
                break;

            case REGFLAG_END_OF_TABLE :
                break;

            default:
				dsi_set_cmdq_V2(cmd, table[i].count, table[i].para_list, force_update);
        }
    }

}

/* ---------------------------------------------------------------------------
   LCM Driver Implementations
   --------------------------------------------------------------------------- */

static void lcm_set_util_funcs(const LCM_UTIL_FUNCS *util)
{
    memcpy(&lcm_util, util, sizeof(LCM_UTIL_FUNCS));
}

static void lcm_get_params(LCM_PARAMS *params)
{
	memset(params, 0, sizeof(LCM_PARAMS));

 params->dsi.LANE_NUM = 3;
 params->dsi.packet_size = 256;
 params->dsi.word_count = 2160;
 params->dsi.horizontal_sync_active = 4;
 params->dsi.lcm_esd_check_table[0].cmd = 0x0A;
 params->dsi.lcm_esd_check_table[0].para_list[0] = 0x00;
 params->dsi.PLL_CLOCK = 239;
 params->type = 2;
 params->dsi.data_format.format = 2;
 params->dsi.PS = 2;
 params->dsi.vertical_sync_active = 2;
 params->width = 720;
 params->dsi.horizontal_active_pixel = 720;
 params->height = 1280;
 params->dsi.vertical_active_line = 1280;
 params->dbi.te_mode = 0;
 params->dsi.data_format.color_order = 0;
 params->dsi.data_format.trans_seq = 0;
 params->dsi.data_format.padding = 0;
 params->dsi.intermediat_buffer_num = 0;
 params->dsi.mode = 1;
 params->dsi.esd_check_enable = 1;
 params->dsi.customization_esd_check_enable = 1;
 params->dsi.lcm_esd_check_table[0].count = 1;
 params->dsi.ssc_disable = 1;
 params->dsi.compatibility_for_nvk = 1;
 params->dsi.vertical_backporch = 20;
 params->dsi.vertical_frontporch = 20;
 params->dsi.horizontal_backporch = 40;
 params->dsi.horizontal_frontporch = 40;
}

static unsigned int lcm_compare_id(void)
{
/*
	enable only when you're using two or more lcms in kernel and remove return 1;

	unsigned int id=0;
	unsigned char buffer[5];
	unsigned int array[16];

	SET_RESET_PIN(1);
	MDELAY(10); 	
	SET_RESET_PIN(0);
	MDELAY(50);
	SET_RESET_PIN(1);
	MDELAY(120);  

	array[0]=0x00063902;
	array[1]=0x52AA55F0;
	array[2]=0x00000108;
	dsi_set_cmdq(&array, 3, 1);
	
	array[0] = 0x00033700;
	dsi_set_cmdq(&array, 1, 1);
	read_reg_v2(0xc5, buffer, 3);
	
	printk("lcm_compare_id nt35521 buffer[0] = 0x%x,buffer[1] = 0x%x,buffer[2] = 0x%x\n",buffer[0],buffer[1],buffer[2]);

	if( (buffer[0]==0x55) && (buffer[1]==0x21) )
	{
		return 1;
	}
	else
	{
		return 0;
	}		
*/
	return 1;
}

static void lcm_init(void)
{
	SET_RESET_PIN(1);
	SET_RESET_PIN(0);
	MDELAY(50);
	SET_RESET_PIN(1);
	MDELAY(120);      
}

static void lcm_suspend(void)
{
	SET_RESET_PIN(0);
	MDELAY(120);
}

static void lcm_resume(void)
{
	lcm_init();
}

/* ---------------------------------------------------------------------------
   Get LCM Driver Hooks
   --------------------------------------------------------------------------- */

LCM_DRIVER nt35521_hd720_dsi_vdo_rixin_lcm_drv = 
{
        .name		= "nt35521_hd720_dsi_vdo_rixin",
	.set_util_funcs = lcm_set_util_funcs,
	.get_params     = lcm_get_params,
	.init           = lcm_init,
	.suspend        = lcm_suspend,
	.resume         = lcm_resume,
	.compare_id     = lcm_compare_id,
};
